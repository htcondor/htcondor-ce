
###############################################################################
#
# HTCondor-CE JobRouter configuration
#
# DO NOT EDIT THIS FILE!  It will be overwritten upon RPM upgrade.
# If you wish to make changes to the HTCondor-CE configuration, create files
# in /etc/condor-ce/config.d containing your changes.
#
###############################################################################

# The below script generates proper settings for JOB_ROUTER_DEFAULTS, merged
# with OSG environment variables (if present).  Anytime you reconfig the OSG,
# you will need to reconfig HTCondor-CE
LOCAL_CONFIG_FILE = /usr/share/condor-ce/condor_ce_router_defaults|

# Set the maximum number of jobs the CE is willing to run.  Note this
# affects both GRIDMANAGER_MAX_SUBMITTED_JOBS_PER_RESOURCE (for non-HTCondor
# sites) and JOB_ROUTER_DEFAULTS
CONDORCE_MAX_JOBS = 10000
GRIDMANAGER_MAX_SUBMITTED_JOBS_PER_RESOURCE = $(CONDORCE_MAX_JOBS)

# Only route jobs for either the vanilla or standard universe.
JOB_ROUTER_SOURCE_JOB_CONSTRAINT = target.JobUniverse =?= 5 || target.JobUniverse =?= 1

# Put jobs on hold if they are not in the removed state and meet any of the following requirements:
# 1. It has not been routed by the CE and is not a standard, vanilla, scheduler, or local job.
HOLD_CLAUSE_1 = (RoutedBy is null && JobUniverse =!= 1 && JobUniverse =!= 5 && JobUniverse =!= 7 && JobUniverse =!= 12)
HOLD_REASON_1 = "invalid job universe."

# 2. It has not been routed by the CE and has been idle for 30+ min
HOLD_CLAUSE_2 = ((JobStatus =?= 1 && time() - EnteredCurrentStatus > 1800) && RoutedToJobId is null && RoutedJob =!= true)
HOLD_REASON_2 = "no matching routes, route job limit, or route failure threshold; see 'HTCondor-CE Troubleshooting Guide'"

SYSTEM_PERIODIC_HOLD = $(JobStatus != 3) && \
                           ($(HOLD_CLAUSE_1) || \
                            $(HOLD_CLAUSE_2))

SYSTEM_PERIODIC_HOLD_REASON = \
   strcat("HTCondor-CE held job due to ", \
            $(HOLD_CLAUSE_1) ? $(HOLD_REASON_1) : \
                               $(HOLD_REASON_2) \
          )


# Remove jobs that have been on hold for longer than 24 hrs
REMOVE_CLAUSE_1 = (JobStatus == 5 && time() - EnteredCurrentStatus > 3600*24)
REMOVE_REASON_1 = "being in the hold state for 24 hours."

# Remove routed jobs that have already started once,
# Users can allow jobs to try more than once on the batch side by setting "ENABLE_JOB_RETRIES = True"
ENABLE_JOB_RETRIES = False
REMOVE_CLAUSE_2 = ((!isUndefined(RoutedtoJobId) && $(ENABLE_JOB_RETRIES) =!= True) && \
                    ((JobStatus == 1 && NumJobStarts == 1) || (NumJobStarts > 1)))
REMOVE_REASON_2 = "disabled job retries"

# Remove completed jobs that have been in that state for over 30 days
COMPLETED_JOB_EXPIRATION = 30
REMOVE_CLAUSE_3 = (JobStatus == 4 && time() - EnteredCurrentStatus > $(COMPLETED_JOB_EXPIRATION)*3600*24)
REMOVE_REASON_3 = strcat("job completed over ", $(COMPLETED_JOB_EXPIRATION), " days ago.")

# Remove jobs that
REMOVE_CLAUSE_4 = (JobUniverse == 5 && \
                   JobStatus == 2 && \
                   time() - JobCurrentStartExecutingDate > \
                       maxWalltime isnt defined ? $(ROUTED_JOB_MAX_TIME)*60 : maxWalltime*60 )
REMOVE_REASON_4 = strcat("job exeeded allowed walltime: ", \
                         maxWalltime isnt defined ? $(ROUTED_JOB_MAX_TIME)*60 : maxWalltime*60, \
                         "min")

SYSTEM_PERIODIC_REMOVE =  $(REMOVE_CLAUSE_1) || \
                          $(REMOVE_CLAUSE_2) || \
                          $(REMOVE_CLAUSE_3) || \
                          $(REMOVE_CLAUSE_4)

DEFAULT_REMOVE_REASON = "input files missing."

SYSTEM_PERIODIC_REMOVE_REASON = \
   strcat("CE job removed by SYSTEM_PERIODIC_REMOVE due to ", \
          $(REMOVE_CLAUSE_1) ? $(REMOVE_REASON_1) : \
          $(REMOVE_CLAUSE_2) ? $(REMOVE_REASON_2) : \
          $(REMOVE_CLAUSE_3) ? $(REMOVE_REASON_3) : \
          $(REMOVE_CLAUSE_4) ? $(REMOVE_REASON_4) : \
                               $(DEFAULT_REMOVE_REASON) \
   )

# This attribute limits the max time of any job to 72 hours.
ROUTED_JOB_MAX_TIME = 4320

# Give the job router a unique name to distinguish the HTCondor-CE jobs from
# the site JobRouter jobs.
JOB_ROUTER_NAME = htcondor-ce

# The version of the HTCondor-CE.  Useful for debugging purposes.
HTCondorCEVersion = "@HTCONDORCE_VERSION@"
grid_resource = strcat("condor ", ifThenElse(size("$(SCHEDD_NAME)") > 0, "$(SCHEDD_NAME)", "$(FULL_HOSTNAME)"), " ", "$(COLLECTOR_HOST)")
SCHEDD_ATTRS = $(SCHEDD_ATTRS) HTCondorCEVersion grid_resource

# Use the defaults generated by the condor_ce_router_defaults script.  To add
# additional defaults, add additional lines of the form:
#
#   JOB_ROUTER_DEFAULTS = $(JOB_ROUTER_DEFAULTS) [set_foo = 1;]
#
MERGE_JOB_ROUTER_DEFAULT_ADS=True
JOB_ROUTER_DEFAULTS = $(JOB_ROUTER_DEFAULTS_GENERATED)
